name: Release
permissions:
  contents: write

on:
  release:
    types: [published]

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      - name: Run Tests
        run: zig build test


  build-library:
    name: Build Library (${{ matrix.target }})
    needs: test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target:
          - x86_64-windows
          - x86-windows
          - x86_64-linux
          - aarch64-linux
          - x86_64-macos
          - aarch64-macos
    steps:
      - uses: actions/checkout@v5
      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2
      
      - name: Build Library
        run: zig build -Doptimize=ReleaseSafe -Dtarget=${{ matrix.target }}

      - name: Prepare Release Artifacts
        run: |
          mkdir -p release
          touch release/placeholder-${{ matrix.target }}.txt

      - name: Upload Release Artifacts
        run: |
          gh release upload "${{ github.event.release.tag_name }}" release/* --clobber || true
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}

  update-release:
    name: Update Release Description
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      
      - name: Get Release URL
        id: get_url
        run: echo "url=https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz" >> $GITHUB_OUTPUT

      - uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Calculate Hash
        id: calc_hash
        run: |
          HASH=$(zig fetch ${{ steps.get_url.outputs.url }})
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Update Release Body
        uses: softprops/action-gh-release@v1
        with:
          body: |
            ${{ github.event.release.body }}

            ## ðŸ“ƒ Documentation
            https://muhammad-fiaz.github.io/zix/

            ## ðŸ“¦ Installation
            ```bash
            zig fetch --save https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.event.release.tag_name }}.tar.gz
            ```
            
            Hash:
            ```zig
            .hash = "${{ steps.calc_hash.outputs.hash }}"
            ```


